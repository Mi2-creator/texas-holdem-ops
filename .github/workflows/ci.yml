# =============================================================================
# Texas Hold'em Ops - CI/CD Pipeline
# =============================================================================
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  GO_VERSION: '1.22'

jobs:
  # ---------------------------------------------------------------------------
  # Lint and validate ops configuration
  # ---------------------------------------------------------------------------
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ops repo
        uses: actions/checkout@v4

      - name: Checkout server repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/texas-holdem-client
          path: texas-holdem-client

      - name: Validate Dockerfile
        run: docker build --check -f docker/Dockerfile texas-holdem-client/

      - name: Validate docker-compose
        run: |
          cp .env.example .env
          docker compose -f docker/docker-compose.yml config

      - name: Shellcheck scripts
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning

  # ---------------------------------------------------------------------------
  # Build Docker image
  # ---------------------------------------------------------------------------
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout ops repo
        uses: actions/checkout@v4

      - name: Checkout server repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/texas-holdem-client
          path: texas-holdem-client

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup environment
        run: |
          cp .env.example .env
          echo "SERVER_SRC=./texas-holdem-client" >> .env
          mkdir -p data

      - name: Build Docker image
        run: make build

      - name: Save Docker image
        run: |
          docker save texas-holdem-server:dev | gzip > texas-holdem-image.tar.gz

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: texas-holdem-image.tar.gz
          retention-days: 1

  # ---------------------------------------------------------------------------
  # Run smoke and e2e tests
  # ---------------------------------------------------------------------------
  test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout ops repo
        uses: actions/checkout@v4

      - name: Checkout server repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/texas-holdem-client
          path: texas-holdem-client

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: |
          gunzip -c texas-holdem-image.tar.gz | docker load

      - name: Setup environment
        run: |
          cp .env.example .env
          echo "SERVER_SRC=./texas-holdem-client" >> .env
          mkdir -p data

      - name: Start server
        run: |
          docker compose -f docker/docker-compose.yml up -d
          sleep 5

      - name: Run smoke tests
        run: ./scripts/smoke.sh

      - name: Run e2e tests
        run: ./scripts/e2e.sh

      - name: Test mode transitions
        run: |
          # Test soft-launch mode
          docker compose -f docker/docker-compose.yml down
          SOFT_LAUNCH=true docker compose -f docker/docker-compose.yml up -d
          sleep 3
          curl -s http://localhost:8080/mode | grep -q "READ_ONLY"

          # Return to normal
          docker compose -f docker/docker-compose.yml down
          docker compose -f docker/docker-compose.yml up -d
          sleep 3
          curl -s http://localhost:8080/mode | grep -q "NORMAL"

      - name: Show logs on failure
        if: failure()
        run: docker compose -f docker/docker-compose.yml logs

      - name: Stop server
        if: always()
        run: docker compose -f docker/docker-compose.yml down

  # ---------------------------------------------------------------------------
  # Run server's own tests
  # ---------------------------------------------------------------------------
  server-tests:
    name: Server Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout server repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/texas-holdem-client
          path: texas-holdem-client

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: texas-holdem-client/server/go/go.sum

      - name: Run tests
        working-directory: texas-holdem-client/server/go
        run: go test -v -race ./...

      - name: Run e2e tests
        working-directory: texas-holdem-client/server/go
        run: go test -v -tags=e2e ./... || true
